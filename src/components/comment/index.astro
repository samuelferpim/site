---
import type { CollectionEntry } from "astro:content";
import { DEFAULT_LOCALE, getKeyToLanguage } from "@i18n/translation";
import { getPostLogicalSlug } from "@utils/content-utils";
import { getPostUrlBySlug } from "@utils/url-utils";
import { commentConfig, siteConfig } from "@/config";
import Disqus from "./Disqus.astro";
import Giscus from "./Giscus.svelte";
import Twikoo from "./Twikoo.astro";

interface Props {
	post: CollectionEntry<"posts">;
	lang?: string;
}

const { post, lang: propLang } = Astro.props;
const { id, data } = post;

// Calculate unified identifiers (without language prefix) to share comments across languages
const logicalSlug = getPostLogicalSlug(post);
const unifiedPath = getPostUrlBySlug(logicalSlug, DEFAULT_LOCALE);
const unifiedUrl = `${Astro.site?.href}${unifiedPath.replace(/^\//, "")}`;

let commentService = "";
if (commentConfig?.disqus) {
	commentService = "disqus";
} else if (commentConfig?.giscus) {
	commentService = "giscus";
} else if (commentConfig?.twikoo) {
	commentService = "twikoo";
}


const lang = getKeyToLanguage(propLang || data.lang || siteConfig.lang);
---
<div class="card-base p-6 mb-4">
  {commentService === 'disqus' && <Disqus identifier={unifiedPath} url={unifiedUrl} title={data.title} lang={lang} />}
  {commentService === 'giscus' && <Giscus client:only="svelte" lang={lang} mapping="specific" term={unifiedPath} />}
  {commentService === 'twikoo' && <Twikoo path={unifiedPath} lang={lang} />}
  {commentService === '' && null}
</div>
